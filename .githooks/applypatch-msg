#!/usr/bin/env bash
# ==============================================================================
# Git Hook: applypatch-msg
# ==============================================================================
# Validates commit messages when applying patches via 'git am'.
# Ensures patch commits follow the same commit message standards.
#
# This hook is triggered by:
# - git am (apply mailbox)
# - git apply with commit creation
#
# Environment Variables:
# - BYPASS_HOOKS=1: Skip validation
#
# Author: Enterprise Development Team
# ==============================================================================

set -euo pipefail

# Source common library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/common.sh
source "${SCRIPT_DIR}/lib/common.sh"

readonly HOOK_NAME="applypatch-msg"

# ==============================================================================
# MAIN HOOK LOGIC
# ==============================================================================

main() {
    local commit_msg_file="$1"
    
    log_to_file "INFO" "$HOOK_NAME" "Hook execution started"
    
    # Check for global bypass
    if should_bypass_hooks; then
        log_bypass "$HOOK_NAME" "Hook bypassed via BYPASS_HOOKS"
        exit 0
    fi
    
    # Read commit message (first line only)
    local commit_msg
    commit_msg=$(head -n 1 "$commit_msg_file" | tr -d '\n')
    
    log_to_file "INFO" "$HOOK_NAME" "Validating patch message: $commit_msg"
    
    # Validate commit message format
    if validate_commit_message "$commit_msg"; then
        log_to_file "INFO" "$HOOK_NAME" "Patch message valid: $commit_msg"
        exit 0
    fi
    
    # Message is invalid
    local error_details="Patch message must follow: <type>: <JIRA-ID> <description>"
    local suggestions=()
    
    local current_branch
    current_branch=$(get_current_branch)
    
    local jira_id="PROJ-123"
    if jira_id=$(extract_jira_id "$current_branch"); then
        : # JIRA ID found
    fi
    
    suggestions+=("Your message: \"$commit_msg\"")
    suggestions+=("")
    suggestions+=("Fix option 1 - Interactive mode:")
    suggestions+=("  git am --abort")
    suggestions+=("  git am --interactive <patch-file>.patch")
    suggestions+=("  # Press 'e' to edit message")
    suggestions+=("")
    suggestions+=("Fix option 2 - Apply and amend:")
    suggestions+=("  git am --no-verify <patch-file>.patch")
    suggestions+=("  git commit --amend -m \"feat: $jira_id apply patch description\"")
    suggestions+=("")
    suggestions+=("ðŸ”„ Undo applied patch:")
    suggestions+=("  git am --abort        # Before patch is applied")
    suggestions+=("  git reset --hard HEAD~1  # After patch is applied")
    suggestions+=("  git reflog            # Recover if needed")
    
    report_error "$HOOK_NAME" "Invalid Patch Message" "$error_details" "${suggestions[@]}"
    exit 1
}

# Execute main function
main "$@"
